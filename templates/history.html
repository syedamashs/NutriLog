<!DOCTYPE html>
<html lang="en">
<head>
    {% load tz %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NutriLog - History</title>
    <link rel="icon" type="image/png" href="/data/nutrilog_logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071024,#071a2e);color:#e6eef8;padding:28px}
        .container{max-width:1100px;margin:0 auto}
        .header{display:flex;align-items:center;justify-content:space-between;gap:12px}
        .title{font-size:20px;font-weight:700}
        .muted{color:#9fb3d9}
        /* Button base to match dashboard analytics button */
        .btn, .muted-btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#9fb3d9;text-decoration:none;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
        .btn:hover, .muted-btn:hover{background:rgba(0,180,255,0.12);color:#071028;border-color:rgba(0,180,255,0.85);font-weight:700}
        .logo{width:64px;height:64px;border-radius:10px;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 24px rgba(0,0,0,0.25);transition:transform .32s cubic-bezier(.2,.9,.3,1);cursor:pointer}
        .logo img{width:100%;height:100%;object-fit:cover}
        .logo-fallback{font-weight:900;font-size:18px}
        .logo:hover{transform:translateY(-8px) scale(1.22) rotate(-8deg)}
        .profile-menu{position:relative}
        .profile-avatar{width:36px;height:36px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(90deg,#ffd6a5,#ff7a9a);color:#071028;font-weight:800;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
        .profile-dropdown{position:absolute;right:0;top:44px;background:#071022;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;min-width:140px;display:none;z-index:999}
        .profile-dropdown a{display:block;padding:8px;color:#e6eef8;text-decoration:none;border-radius:6px}
        /* Unified dropdown hover styles (match profile) */
        .profile-dropdown a:hover{background:rgba(0,180,255,0.12);color:#ffffff;font-weight:700}
        .muted-btn:hover{background:rgba(0,180,255,0.08);color:#00b4ff;border-color:rgba(0,180,255,0.85)}
        .range-btn:hover{background:rgba(0,180,255,0.06);color:#00b4ff}
        select{background:rgba(255,255,255,0.02);color:#e6eef8;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px}
        select:focus{outline:2px solid rgba(0,180,255,0.12);box-shadow:0 6px 18px rgba(0,180,255,0.06);}
        select option{background:#071022;color:#e6eef8} 
        .controls{display:flex;align-items:center}

        .top-grid{display:grid;grid-template-columns:1fr 380px;gap:18px;margin-top:18px}
        .card{background:rgba(255,255,255,0.03);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
        .stat-grid{display:flex;gap:12px;margin-top:12px}
        .stat{flex:1;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;text-align:center}
        .stat h4{margin:0;font-size:12px;color:#9fb3d9}
        .stat p{margin:8px 0 0;font-weight:800;font-size:16px}

        .logs{margin-top:18px}
        .log-item{display:flex;justify-content:space-between;padding:10px;border-radius:10px;background:rgba(255,255,255,0.015);border:1px solid rgba(255,255,255,0.02);margin-bottom:8px}
        .log-meta{color:#9fb3d9;font-size:13px}
        .controls{display:flex;gap:8px;align-items:center}

        /* Streak badge (compact, matches screenshot) */
        .streak-badge{display:inline-grid;place-items:center;width:40px;height:40px;border-radius:8px;font-weight:900;color:#fff;font-size:16px;box-shadow:0 6px 14px rgba(0,0,0,0.34);position:relative;padding:4px;text-decoration:none;z-index:10;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
        .streak-badge .streak-fire{position:absolute;left:6px;top:6px;font-size:14px;filter:drop-shadow(0 1px 4px rgba(0,0,0,0.12))}
        .streak-badge .streak-num{font-size:16px;font-weight:900;color:#071028}
        /* Dashboard modifier: slightly larger for home page */
        .streak-badge--home{width:64px;height:64px;border-radius:12px;font-size:20px;background:var(--accent-solid);color:#071028}
        .streak-badge--home .streak-fire{font-size:20px}
        .streak-badge--home .streak-num{font-size:20px}
        .streak-increment{animation:streak-pop .95s cubic-bezier(.2,.9,.2,1)}
        @keyframes streak-pop{0%{transform:scale(1);opacity:1}40%{transform:scale(1.28);opacity:1}100%{transform:scale(1);opacity:1}}

        @media (max-width:980px){.top-grid{grid-template-columns:1fr}}

        /* range buttons in Export / Controls */
        .range-btn{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6eef8;cursor:pointer;font-weight:700;transition:all .12s ease}
        .range-btn.active{color:#071028;background:#00b4ff;border-color:rgba(0,180,255,0.85);box-shadow:0 6px 12px rgba(0,180,255,0.12)}
    </style>
</head>
<body>
<div class="container">
    <div id="toast" aria-live="polite" style="position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:rgba(7,16,40,0.98);color:#00b4ff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.4);display:none;font-weight:700;z-index:9999"></div> 
    <div class="header">
        <div style="display:flex;align-items:center;gap:12px">
            <div class="logo"><img src="/data/nutrilog_logo.png" alt="NutriLog" onerror="this.style.display='none'; this.parentElement.querySelector('.logo-fallback').style.display='flex'"/><div class="logo-fallback" style="display:none;align-items:center;justify-content:center;width:100%;height:100%;font-weight:800;color:#fff">NL</div></div>
            <div>
                <div class="title">Meal History</div>
                <div class="muted">Overview of your past meals and daily totals</div>
            </div>
        </div>
        <div class="controls">
            <a href="/" class="muted-btn">Back to Dashboard</a>
            {% if user.is_authenticated %}
            <div style="margin-left:12px;display:flex;align-items:center;gap:8px">
                <div style="font-size:12px;color:#9fb3d9">Streak</div>
                <a href="/analytics/logs/" style="text-decoration:none">
                    <div class="streak-badge" data-count="{{ streak.count }}" data-color="{{ streak.color }}" role="img" aria-label="{{ streak.count }} day streak">
                        <span class="streak-fire">ðŸ”¥</span>
                        <span class="streak-num">{{ streak.count }}</span>
                    </div>
                </a>
            </div>
            <div style="margin-left:12px" class="profile-menu">
                <button id="profileBtn" class="profile-avatar" aria-haspopup="true" aria-expanded="false" title="{{ user.username }}">
                    <span class="initial">{{ user.username|slice:":1"|upper }}</span>
                </button>
                <div class="profile-dropdown" id="profileDropdown" role="menu">
                    <a href="/profile/">View profile</a>
                    <a href="/logout/">Logout</a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ANALYTICS HEADER CARDS -->
    <div style="display:grid;grid-template-columns:1.2fr repeat(3,1fr);gap:12px;margin-top:18px">
        <div class="card">
            <div style="font-size:12px;color:#9fb3d9">Total calories (last {{ series_days }} days)</div>
            <div style="font-weight:800;font-size:20px;margin-top:8px">{{ total_calories }} kcal</div>
            <div class="muted" style="margin-top:8px">Avg/day: <strong>{{ avg_calories }} kcal</strong></div>
        </div>

        <div class="card">
            <div style="font-size:12px;color:#9fb3d9">Today's calories</div>
            <div style="font-weight:800;font-size:20px;margin-top:8px">{% if total_today %}{{ total_today.calories }} kcal{% else %}0 kcal{% endif %}</div>
            <div class="muted" style="margin-top:8px">
                Protein: <strong>{{ total_today.protein_g|default:0 }} g</strong> â€¢ 
                Fat: <strong>{{ total_today.fat_g|default:0 }} g</strong> â€¢ 
                Carbs: <strong>{{ total_today.carbs_g|default:0 }} g</strong>
            </div>
        </div>

        <div class="card">
            <div style="font-size:12px;color:#9fb3d9">Change vs previous {{ series_days }}d</div>
            <div style="font-weight:800;font-size:20px;margin-top:8px">{% if pct_change != None %}{% if pct_change > 0 %}+{% endif %}{{ pct_change }}%{% else %}â€”{% endif %}</div>
            <div class="muted" style="margin-top:8px">Prev total: {{ prev_total }} kcal</div>
        </div>
        <div class="card">
            <div style="font-size:12px;color:#9fb3d9">Key stats (last {{ series_days }} days)</div>
            <div style="margin-top:10px;display:flex;flex-direction:column;gap:10px">
                <div style="display:flex;justify-content:space-between"><div class="muted">Days with data</div><div style="font-weight:800">{{ days_with_data }}</div></div>
                <div style="display:flex;justify-content:space-between"><div class="muted">Max / Day</div><div style="font-weight:800">{{ max_daily_calories }} kcal</div></div>
                <div style="display:flex;justify-content:space-between"><div class="muted">Avg / day</div><div style="font-weight:800">{{ avg_calories }} kcal</div></div>

            </div>
        </div>
    </div>

    <div style="display:grid;grid-template-columns:2fr 380px;gap:18px;margin-top:18px">
        <div class="card">
            <h4 style="margin:0">Daily calories trend</h4>
            <div class="muted" style="margin-top:6px">Trend over the last {{ series_days }} days</div>
            <div style="margin-top:12px;height:320px;position:relative">
                <canvas id="trendChart" style="width:100%;height:100%"></canvas>
                <div id="trendHoverBox" style="position:absolute;right:12px;top:12px;background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);color:#e6eef8;display:none"></div>
                <div id="weeklyNoData" style="display:none;position:absolute;left:0;right:0;top:0;bottom:0;align-items:center;justify-content:center;color:#9fb3d9">No recent data</div>
            </div>

            <!-- Goal & quick stats panel (arranged as two columns: left = Daily goal + TDEE, right = Remaining + BMR) -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:48px">
                <div style="display:flex;flex-direction:column;gap:12px">
                    <div style="background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)">
                        <div style="font-size:12px;color:#9fb3d9">Daily goal</div>
                        <div style="font-weight:900;font-size:16px;margin-top:6px">{{ goal }} kcal {% if profile_bmr %}<small style="color:#9fb3d9;font-weight:700;margin-left:8px">(BMR-based)</small>{% endif %}</div>
                        <div class="muted" style="margin-top:6px">Hit rate: <strong>{{ goal_hit_rate }}%</strong> â€¢ Days logged: <strong>{{ days_with_data }}</strong></div>
                    </div>

                    <div style="background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)">
                        <div style="font-size:12px;color:#9fb3d9">Suggested TDEE</div>
                        <div style="font-weight:900;font-size:16px;margin-top:6px">{% if tdee_suggestion %}{{ tdee_suggestion }} kcal/day{% else %}<span class="muted">â€”</span>{% endif %}</div>
                        <div class="muted" style="margin-top:6px">(Sedentary multiplier Ã—1.2)</div>
                    </div>
                </div>

                <div style="display:flex;flex-direction:column;gap:12px">
                    <div style="background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)">
                        <div style="font-size:12px;color:#9fb3d9">Remaining to goal</div>
                        <div style="font-weight:900;font-size:16px;margin-top:6px">{{ remaining_goal }} kcal</div>
                        <div class="muted" style="margin-top:6px">Today: <strong>{{ total_today.calories }} kcal</strong> â€¢ Goal: <strong>{{ goal }} kcal</strong></div>
                    </div>

                    <div style="background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)">
                        <div style="font-size:12px;color:#9fb3d9">BMR (estimate)</div>
                        <div style="font-weight:900;font-size:15px;margin-top:6px">{% if profile_bmr %}{{ profile_bmr }} kcal/day{% else %}<span class="muted">â€”</span>{% endif %}</div>
                        <div class="muted" style="margin-top:6px">(Basal Metabolic Rate)</div>
                    </div>
                </div>
            </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:12px">
            <div class="card">
                <h4 style="margin:0">Meal type breakdown</h4>
                <div class="muted" style="margin-top:6px">Calories by meal type (last {{ series_days }}d)</div>
                <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
                    <div style="flex:1"><canvas id="mealTypeChart" width="140" height="140"></canvas></div>
                    <div style="width:160px">
                        {% if meal_type_items %}
                            {% for mt, val in meal_type_items %}
                                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px">
                                    <div class="muted" style="flex:1;min-width:0;white-space:normal;word-break:break-word">{{ mt }}</div>
                                    <div style="font-weight:800;min-width:60px;text-align:right">{{ val|floatformat:1 }} kcal</div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="muted">No data</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card">
                <h4 style="margin:0">Macros totals</h4>
                <div class="muted" style="margin-top:6px">Protein / Fat / Carbs (last {{ series_days }}d)</div>
                <div style="margin-top:12px">
                    <div style="display:flex;justify-content:space-between"><div class="muted">Protein</div><div style="font-weight:800">{{ macros_totals.protein_g|floatformat:1 }} g</div></div>
                    <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="muted">Fat</div><div style="font-weight:800">{{ macros_totals.fat_g|floatformat:1 }} g</div></div>
                    <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="muted">Carbs</div><div style="font-weight:800">{{ macros_totals.carbs_g|floatformat:1 }} g</div></div>
                </div>
            </div>

            <div class="card">
                <h4 style="margin:0">Monthly activity heatmap</h4>
                <div class="muted" style="margin-top:6px">Last {{ series_days }} days â€” darker = more calories</div>
                <div id="calendarHeatmap" style="margin-top:12px;display:flex;gap:12px;align-items:flex-start">
                    <div id="calendarLabels" style="display:flex;flex-direction:column;gap:4px;padding-right:8px;min-width:28px"></div>
                    <div id="calendarGrid" style="display:grid;grid-auto-flow:column;grid-auto-rows:14px;gap:4px"></div>
                    <div id="heatLegend" style="width:120px;font-size:12px;color:#9fb3d9"></div>
                </div>
            </div>
        </div>
    </div>


    <div style="margin-top:18px" class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
            <h4 style="margin:0 0 12px">Recent Meals (top 5)</h4>
            <div style="display:flex;gap:8px;align-items:center">
                <a href="/analytics/logs/" class="muted-btn" style="text-decoration:none">Open Logs Page</a>
            </div>
        </div>
        <div id="allMealsList">
            {% for log in logs|slice:":5" %}
                <div data-log-date="{{ log.local_created|date:'Y-m-d' }}" style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.03)">
                    <div>
                        <div style="font-weight:700">{{ log.computed_icon }} {{ log.meal_name }} <span class="muted" style="font-weight:600;font-size:12px">Â· {{ log.computed_type }}</span></div>
                        <div class="log-meta">{{ log.created_at|timezone:"Asia/Kolkata"|date:"M d h:i A T" }}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight:800">{{ log.calories }} kcal</div>
                        <div class="log-meta">{{ log.protein_g }} g â€¢ {{ log.fat_g }} g</div>
                    </div>
                </div>
            {% empty %}
                <div class="muted">No meals logged yet.</div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Chart.js CDN -->

<script id="history-data" type="application/json">
{
  "total_today": { "protein": {{ total_today.protein_g|default:0 }}, "fat": {{ total_today.fat_g|default:0 }}, "carbs": {{ total_today.carbs_g|default:0 }} },
  "goal": {{ goal|default:2000 }},
  "profile_bmr": {{ profile_bmr|default:'null' }},
  "tdee_suggestion": {{ tdee_suggestion|default:'null' }},
  "weekly_max_adj": {{ weekly_max_adj|default:0 }},
  "series_days": {{ series_days|default:30 }},
  "series": [
    {% for s in series %}
      {"date":"{{ s.date|date:'M d'|escapejs }}","calories":{{ s.calories }},"protein":{{ s.protein_g }},"fat":{{ s.fat_g }},"carbs":{{ s.carbs_g }}}{% if not forloop.last %},{% endif %}
    {% endfor %}
  ],
  "meal_type_items": [
    {% for mt, val in meal_type_items %}
      ["{{ mt|escapejs }}", {{ val }}]{% if not forloop.last %},{% endif %}
    {% endfor %}
  ],
  "logs": [
    {% for log in logs %}
      {"created_at":"{{ log.created_at|timezone:'Asia/Kolkata'|date:'Y-m-d H:i:s' }}","meal_name":"{{ log.meal_name|escapejs }}","calories":{{ log.calories }},"protein_g":{{ log.protein_g }},"fat_g":{{ log.fat_g }},"carbs_g":{{ log.carbs_g }},"fiber_g":{{ log.fiber_g }}}{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>

{{ calendar_heatmap|default:"{}"|json_script:"calendar-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    (function(){
        try{
            const macroCtx = document.getElementById('macroHistoryChart');
            const DASH = (function(){ try{ return JSON.parse(document.getElementById('history-data').textContent); }catch(e){ return { total_today: {protein:0,fat:0,carbs:0}, series:[], meal_type_items:[], logs:[] }; } })();
            const p = Number(DASH.total_today && DASH.total_today.protein) || 0;
            const f = Number(DASH.total_today && DASH.total_today.fat) || 0;
            const c = Number(DASH.total_today && DASH.total_today.carbs) || 0;
            if(macroCtx){
                // compact, cleaner doughnut (legend hidden in favor of custom boxes)
                new Chart(macroCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Protein','Fat','Carbs'],
                        datasets: [{ data: [p,f,c], backgroundColor: ['#4fd1c5','#ffd166','#ffa69e'] }]
                    },
                    options: {
                        cutout: '80%',
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: function(ctx){ return ctx.label + ': ' + ctx.formattedValue + ' g' } } }
                        },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            // main trend chart (uses server-side series)
            const trendCtx = document.getElementById('trendChart');
            if(trendCtx){
                // Use series from history-data JSON
                const labels = (DASH.series || []).map(s => s.date);
                const data = (DASH.series || []).map(s => Number(s.calories||0));
                const prot = (DASH.series || []).map(s => Number(s.protein||0));
                const fat = (DASH.series || []).map(s => Number(s.fat||0));
                const carbs = (DASH.series || []).map(s => Number(s.carbs||0));

                const hasData = data.some(v=>v>0);
                const nod = document.getElementById('weeklyNoData');
                if(!hasData){ if(nod) nod.style.display = 'flex'; }

                const suggestedMax = Math.max(Number(DASH.weekly_max_adj || 0), Number((DASH.goal || 2000) * 1.05));
                const stepSize = Math.max(1, Math.ceil(suggestedMax / 4));

                const ctx = trendCtx.getContext ? trendCtx.getContext('2d') : null;
                const grad = ctx ? (function(){const g=ctx.createLinearGradient(0,0,0,320); g.addColorStop(0,'rgba(255,122,154,0.32)'); g.addColorStop(1,'rgba(255,122,154,0.04)'); return g;}()) : '#ff7a9a';

                const trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Calories', data: data, borderColor:'#ff7a9a', backgroundColor: grad, fill:true, tension:0.25, pointRadius:3, pointBackgroundColor:'#fff', pointBorderColor:'#ff7a9a' },
                            { label: 'Goal', data: new Array(data.length).fill(DASH.goal || 2000), borderColor:'#00b4ff', borderDash:[6,6], pointRadius:0, fill:false }
                        ]
                    },

                    options: {
                        scales: { y: { beginAtZero:true, suggestedMax: suggestedMax, ticks:{ stepSize: stepSize } }, x:{ grid:{display:false} } },
                        plugins: { legend:{display:false}, tooltip:{mode:'index',intersect:false,callbacks:{label:function(ctx){ return ctx.dataset.label + ': ' + ctx.parsed.y + ' kcal'; }}} },
                        responsive:true, maintainAspectRatio:false,
                        interaction:{ mode:'index', intersect:false },
                        onHover: function(e, active){ const hb = document.getElementById('trendHoverBox'); if(active && active.length){ const idx = active[0].index; hb.style.display='block'; hb.innerHTML = '<div style="font-weight:800">'+labels[idx]+'</div><div style="font-size:13px;color:#9fb3d9">Calories: '+data[idx]+' kcal</div><div style="font-size:12px;color:#9fb3d9">Protein: '+prot[idx]+' g â€¢ Fat: '+fat[idx]+' g â€¢ Carbs: '+carbs[idx]+' g</div>'; } else { hb.style.display='none'; } }
                    }
                });
            }

            // meal type doughnut
            const mealTypeCtx = document.getElementById('mealTypeChart');
            if(mealTypeCtx){
                const mtLabels = (DASH.meal_type_items || []).map(x=>x[0]);
                const mtData = (DASH.meal_type_items || []).map(x=>x[1]);
                new Chart(mealTypeCtx, { type:'doughnut', data:{ labels:mtLabels, datasets:[{ data:mtData, backgroundColor:['#ffd166','#ffa69e','#4fd1c5','#a9def9','#ffd6a5'] }] }, options:{ plugins:{ legend:{display:false} }, cutout:'60%', responsive:true, maintainAspectRatio:false } });
            }

            // build calendar heatmap (LeetCode-style)
            (function(){
                const calEl = document.getElementById('calendar-data');
                const cal = (function(){ try{ return calEl ? JSON.parse(calEl.textContent) : { days: [] }; }catch(e){ return { days: [] }; } })();
                const grid = document.getElementById('calendarGrid');
                const labels = document.getElementById('calendarLabels');
                if(!grid || !cal || !cal.days) return;
                grid.innerHTML = '';
                labels.innerHTML = '';
                const weeks = cal.weeks || 1;
                const dayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
                const fullNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
                dayNames.forEach((n,i) => { const el = document.createElement('div'); el.textContent = n; el.title = fullNames[i]; el.style.color='#9fb3d9'; el.style.fontSize='11px'; el.style.height='14px'; el.style.lineHeight='14px'; el.style.margin='3px 0'; labels.appendChild(el); });
                // medium-sized heatmap boxes (taller than compact, smaller than large)
                grid.style.gridTemplateRows = 'repeat(7,19.3px)';
                grid.style.gridTemplateColumns = 'repeat('+weeks+',15.5px)';
                const max = cal.max || 0;
                const matrix = Array.from({length:weeks}, ()=> Array.from({length:7}, ()=> null));
                cal.days.forEach(d => { if(typeof d.week === 'number' && typeof d.weekday === 'number') matrix[d.week][d.weekday] = d; });
                let hasData = false;
                // fixed bucket color mapping (stable across ranges) â€” more buckets with increasing intensity
                function colorFor(cals){
                    if(!cals || cals <= 0) return 'rgba(255,255,255,0.02)';
                    if(cals <= 200) return 'rgba(255,122,154,0.18)';     // very light
                    if(cals <= 500) return 'rgba(255,102,135,0.32)';     // light
                    if(cals <= 1000) return 'rgba(255,80,120,0.5)';      // medium
                    if(cals <= 1400) return 'rgba(255,64,110,0.68)';     // strong
                    if(cals <= 2000) return 'rgba(255,40,90,0.86)';      // very strong
                    return 'rgba(255,20,60,0.98)';                       // extreme
                }
                for(let w=0; w<weeks; w++){
                    for(let wd=0; wd<7; wd++){
                        const cell = document.createElement('div');
                        cell.style.width='14px'; cell.style.height='18px'; cell.style.borderRadius='3px'; cell.style.margin='3px 0';
                        const day = matrix[w][wd];
                        if(day){
                            cell.style.background = colorFor(day.calories);
                            cell.title = day.date + ' â€” ' + day.calories + ' kcal';
                            // make cells clickable: go to logs filtered for that date
                            cell.style.cursor = 'pointer';
                            cell.addEventListener('click', (function(d){ return function(){ window.location.href = '/analytics/logs/?date='+d; } })(day.date));
                            hasData = hasData || day.calories>0;
                        } else {
                            cell.style.background = 'transparent';
                        }
                        grid.appendChild(cell);
                    }
                }
                const legend = document.getElementById('heatLegend');
                if(legend){
                    legend.innerHTML = '<div style="margin-bottom:6px;color:#9fb3d9">Legend</div>';
                    // New buckets: 0 (no color), 1-200, 201-500, 501-1000, 1001-1400, 1401-2000, >2000
                    const buckets = [
                        {label: '0 kcal', value: 0},
                        {label: '1â€“200 kcal', value: 200},
                        {label: '201â€“500 kcal', value: 500},
                        {label: '501â€“1000 kcal', value: 1000},
                        {label: '1001â€“1400 kcal', value: 1400},
                        {label: '1401â€“2000 kcal', value: 2000},
                        {label: '>2000 kcal', value: 999999}
                    ];

                    buckets.forEach(b => {
                        const bg = colorFor(b.value);
                        legend.innerHTML += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px"><div style="width:20px;height:10px;border-radius:3px;background:'+bg+'"></div><div style="font-size:12px;color:#9fb3d9">'+b.label+'</div></div>';
                    });
                }
                const nod = document.getElementById('weeklyNoData');
                if(nod) nod.style.display = hasData ? 'none' : 'flex';
            })();

            // setRange helper (reloads page with days param) + persist selection (validates input)
            window.setRange = function(d){ try{ const s = String(d).trim(); if(!['7','14','30'].includes(s)) return; localStorage.setItem('history_days', s); const params = new URLSearchParams(window.location.search); const current = params.get('days'); // if already set to the same days, avoid reloading and just ensure the button is active
                if(current === s){ try{ document.querySelectorAll('.range-btn').forEach(b=>{ if(String(b.dataset.days).trim() === s) b.classList.add('active'); else b.classList.remove('active'); }); if(typeof showToast === 'function') showToast('Showing last '+s+' days'); }catch(e){ if(typeof debugLog === 'function') debugLog('setRange early return failed: '+e) } return; }
                params.set('days', s); window.location.search = params.toString(); }catch(e){console.warn('setRange failed',e)} }

            // if user has a saved range and URL does not specify it, apply it
            // robust initialization of days param (avoid bad values/injection)
            (function(){
                try{
                    const allowed = new Set(['7','14','30']);
                    const params = new URLSearchParams(window.location.search);
                    const daysParam = params.get('days');
                    const stored = localStorage.getItem('history_days');

                    // if stored value is invalid, remove it (prevent repeated bad redirects)
                    if(stored && !allowed.has(stored)){
                        try{ localStorage.removeItem('history_days'); }catch(e){}
                    }

                    // validate stored value
                    const validStored = (stored && allowed.has(stored)) ? stored : null;

                    // if missing or invalid, apply stored if valid; otherwise default to 30
                    let target = null;
                    if(!daysParam || !allowed.has(daysParam)){
                        target = validStored || '30';
                    }

                    if(target){
                        // avoid redirect loops
                        if(!sessionStorage.getItem('history_redirected')){
                            params.set('days', target);
                            sessionStorage.setItem('history_redirected','1');
                            window.location.search = params.toString();
                        }
                    }
                }catch(e){ console.warn('history init days failed', e) }
            })();

            // replace: highlight active range button (uses data-days)
            (function(){
                function setActiveRangeButton(days){
                    const norm = String(days || '').toString().trim();
                    document.querySelectorAll('.range-btn').forEach(b=>{
                        if(String(b.dataset.days || '').toString().trim() === norm) b.classList.add('active'); else b.classList.remove('active');
                    });
                }
                // small debug helper
                function debugLog(msg){ try{ console.debug && console.debug('[history]', msg); }catch(e){} }
                // small toast helper for visible feedback
                let __toastTimer = null;
                function showToast(text, ms=1800){ try{ const t = document.getElementById('toast'); if(!t) return; t.textContent = text; t.style.display = 'block'; if(__toastTimer) clearTimeout(__toastTimer); __toastTimer = setTimeout(()=>{ t.style.display = 'none'; __toastTimer = null; }, ms); }catch(e){ debugLog('showToast failed: '+e) } }

                // attach click handlers (single binding)
                document.querySelectorAll('.range-btn').forEach(btn=>{
                    btn.addEventListener('click', function(){
                        debugLog && debugLog('range clicked: ' + String(btn.dataset.days));
                        const d = btn.dataset.days;
                        setActiveRangeButton(d);
                        try{ setRange(Number(d)); }catch(e){ console.warn('setRange failed',e); }
                    });
                });

                // init active button from URL/localStorage/server
                try{
                    const params = new URLSearchParams(window.location.search);
                    // normalize/trim the value from URL/localStorage/server to avoid mismatches
                    const daysParam = (params.get('days') || localStorage.getItem('history_days') || String(DASH.series_days || 30))?.toString().trim();
                    setActiveRangeButton(daysParam);
                }catch(e){ console.warn('init range button failed', e) }
            })();

            // CSV export â€” unified: attach to all .export-csv buttons (also wire top #downloadHistoryCsv)
            (function(){
                // build an array we can extend (NodeList isn't easy to push to directly)
                const exportButtons = Array.from(document.querySelectorAll('.export-csv'));
                const topExport = document.getElementById('downloadHistoryCsv');
                if(topExport) exportButtons.push(topExport);
                if(!exportButtons || !exportButtons.length) return;
                exportButtons.forEach(function(btn){
                    btn.addEventListener('click', function(){
                        const rows = [['created_at','meal_name','calories','protein_g','fat_g','carbs_g','fiber_g']];
                        const DASH_local = (function(){ try{ return JSON.parse(document.getElementById('history-data').textContent); }catch(e){ return { logs: [] }; } })();
                        const logsData = DASH_local.logs || [];
                        logsData.forEach(function(l){
                            const created = l.created_at || '';
                            // sanitize meal name: remove emoji and trailing " Â· type"
                            let name = String(l.meal_name || '').replace(/[\u{1F300}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').replace(/\s*Â·\s*.*$/, '').trim();
                            const calories = (typeof l.calories !== 'undefined' && l.calories !== null) ? l.calories : '';
                            const protein = (l.protein_g ?? l.protein ?? '');
                            const fat = (l.fat_g ?? l.fat ?? '');
                            const carbs = (l.carbs_g ?? l.carbs ?? '');
                            const fiber = (l.fiber_g ?? l.fiber ?? '');
                            rows.push([created, name, calories, protein, fat, carbs, fiber]);
                        });
                        if(typeof debugLog === 'function') debugLog('Export CSV rows: ' + rows.length);
                        if(typeof showToast === 'function') showToast('Exporting CSV ('+rows.length+' rows)');
                        const csv = rows.map(r => r.map(c=> '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
                        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href = url; a.download = 'meal_history.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                    });
                });
            })();

            // expand/collapse details
            document.querySelectorAll('.log-item').forEach((el)=>{
                el.addEventListener('click',function(){
                    const detail = el.nextElementSibling;
                    if(detail) detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
                });
            });

        }catch(e){console.warn('history page failed',e)}
    })();
</script>
<script>
(function(){
    try{
        const b = document.querySelector('.streak-badge[data-count]');
        if(!b) return;
        b.style.background = b.dataset.color || '#00b4ff';
        const cur = Number(b.dataset.count || 0);
        const key = 'fn_last_streak';
        const prev = Number(localStorage.getItem(key) || 0);
        if(cur > prev && prev >= 0){ b.classList.add('streak-increment'); setTimeout(()=>b.classList.remove('streak-increment'), 1400); }
        localStorage.setItem(key, String(cur));
    }catch(e){console.warn('streak init',e)}
})();
</script>
<script>
(function(){
    try{
        const pBtn = document.getElementById('profileBtn');
        const pDrop = document.getElementById('profileDropdown');
        if(pBtn){
            pBtn.addEventListener('click', function(ev){ ev.stopPropagation(); const opened = pBtn.getAttribute('aria-expanded') === 'true'; pBtn.setAttribute('aria-expanded', String(!opened)); pDrop.style.display = opened ? 'none' : 'block'; });
            document.addEventListener('click', function(){ if(pDrop){ pDrop.style.display = 'none'; pBtn.setAttribute('aria-expanded','false'); } });
        }
    }catch(e){ console.warn('profile menu init', e); }
})();
</script>

<!-- NutriLog modal removed from this page (dashboard-only) -->

</body>
</html>
