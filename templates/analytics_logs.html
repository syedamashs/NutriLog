<!DOCTYPE html>
<html lang="en">
<head>
    {% load tz %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NutriLog - Logs</title>
    <link rel="icon" type="image/png" href="/data/nutrilog_logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071024,#071a2e);color:#e6eef8;padding:28px}
        .container{max-width:1100px;margin:0 auto}
        .header{display:flex;align-items:center;justify-content:space-between;gap:12px}
        .title{font-size:20px;font-weight:700}
        .muted{color:#9fb3d9}
        .card{background:rgba(255,255,255,0.03);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
        .controls{display:flex;gap:8px;align-items:center}

        /* Streak badge (compact, matches screenshot) */
        .streak-badge{display:inline-grid;place-items:center;width:40px;height:40px;border-radius:8px;font-weight:900;color:#fff;font-size:16px;box-shadow:0 6px 14px rgba(0,0,0,0.34);position:relative;padding:4px;text-decoration:none;z-index:10;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
        .streak-badge .streak-fire{position:absolute;left:6px;top:6px;font-size:14px;filter:drop-shadow(0 1px 4px rgba(0,0,0,0.12))}
        .streak-badge .streak-num{font-size:16px;font-weight:900;color:#071028}
        /* Dashboard modifier: slightly larger for home page */
        .streak-badge--home{width:64px;height:64px;border-radius:12px;font-size:20px;background:var(--accent-solid);color:#071028}
        .streak-badge--home .streak-fire{font-size:20px}
        .streak-badge--home .streak-num{font-size:20px}
        .streak-increment{animation:streak-pop .95s cubic-bezier(.2,.9,.2,1)}
        @keyframes streak-pop{0%{transform:scale(1);opacity:1}40%{transform:scale(1.28);opacity:1}100%{transform:scale(1);opacity:1}}
        .muted-small{color:#9fb3d9;font-size:13px}
        /* Logo and profile avatar (match other pages) */
        .logo{width:64px;height:64px;border-radius:10px;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 24px rgba(0,0,0,0.25);transition:transform .32s cubic-bezier(.2,.9,.3,1);cursor:pointer}
        .logo img{width:100%;height:100%;object-fit:cover}
        .logo-fallback{font-weight:900;font-size:18px}
        .logo:hover{transform:translateY(-8px) scale(1.22) rotate(-8deg)}
        .profile-menu{position:relative}
        .profile-avatar{width:36px;height:36px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(90deg,#ffd6a5,#ff7a9a);color:#071028;font-weight:800;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
        .profile-dropdown{position:absolute;right:0;top:44px;background:#071022;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;min-width:140px;display:none;z-index:999}
        .profile-dropdown a{display:block;padding:8px;color:#e6eef8;text-decoration:none;border-radius:6px}
        /* Dropdown + select consistent styling */
        .profile-dropdown a:hover{background:rgba(0,180,255,0.12);color:#ffffff;font-weight:700}
        /* Match dashboard/profile muted button styling */
        .btn, .muted-btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
        .muted-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#9fb3d9}
        .muted-btn:hover{background:rgba(0,180,255,0.08);color:#00b4ff;border-color:rgba(0,180,255,0.85)}
        select{background:rgba(255,255,255,0.02);color:#e6eef8;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px}
        select:focus{outline:2px solid rgba(0,180,255,0.12);box-shadow:0 6px 18px rgba(0,180,255,0.06)}
        select option{background:#071022;color:#e6eef8} 
        /* Formatted details for meal log items */
        .log-details{margin-top:8px}
        .log-details table{width:100%;border-collapse:collapse;margin-top:6px}
        .log-details th{padding:8px 10px;text-align:left;font-weight:700;background:rgba(255,255,255,0.02)}
        .log-details td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.03)}
        .log-details .muted{color:#9fb3d9}
        .log-details pre{white-space:pre-wrap;font-family:monospace;background:rgba(0,0,0,0.06);padding:8px;border-radius:6px;margin:0}
        
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div style="display:flex;align-items:center;gap:12px">
            <div class="logo"><img src="/data/nutrilog_logo.png" alt="NutriLog" onerror="this.style.display='none'; this.parentElement.querySelector('.logo-fallback').style.display='flex'"/><div class="logo-fallback" style="display:none;align-items:center;justify-content:center;width:100%;height:100%;font-weight:800;color:#fff">NL</div></div>
            <div>
                <div class="title">All Meal Logs</div>
                <div class="muted">Search, filter, and export your meal logs</div>
            </div>
        </div>
        <div class="controls">
            <a href="/" class="muted-btn" style="text-decoration: none;">Back to Dashboard</a>
            <button id="exportCsv" style="padding:8px 10px;border-radius:8px;border:none;background:#00b4ff;color:#071028;font-weight:700;cursor:pointer">Export CSV</button>
            {% if user.is_authenticated %}
            <div style="margin-left:12px;display:flex;align-items:center;gap:8px">
                <div style="font-size:12px;color:#9fb3d9">Streak</div>
                <a href="/analytics/logs/" style="text-decoration:none">
                    <div class="streak-badge" data-count="{{ streak.count }}" data-color="{{ streak.color }}" role="img" aria-label="{{ streak.count }} day streak">
                        <span class="streak-fire">ðŸ”¥</span>
                        <span class="streak-num">{{ streak.count }}</span>
                    </div>
                </a>
            </div>
            <div style="margin-left:12px" class="profile-menu">
                <button id="profileBtn" class="profile-avatar" aria-haspopup="true" aria-expanded="false" title="{{ user.username }}">
                    <span class="initial">{{ user.username|slice:":1"|upper }}</span>
                </button>
                <div class="profile-dropdown" id="profileDropdown" role="menu">
                    <a href="/profile/">View profile</a>
                    <a href="/logout/">Logout</a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div style="margin-top:18px" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;gap:8px;align-items:center;">
                <input id="filterDate" type="date" style="background:transparent;border:1px solid rgba(255,255,255,0.03);color:#e6eef8;padding:6px;border-radius:6px" value="{{ now|date:'Y-m-d' }}">
                <input id="q" placeholder="Search meal name..." style="background:transparent;border:1px solid rgba(255,255,255,0.03);color:#e6eef8;padding:6px;border-radius:6px">
                <button onclick="applyFilters()" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6eef8;">Filter</button>
                <button onclick="clearFilters()" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6eef8;">Clear</button>
            </div>
            <div class="muted-small">Showing <strong id="count">{{ logs|length }}</strong> logs</div>
        </div>

        <table id="logsTable">
            <thead>
                <tr><th>Date</th><th>Meal</th><th>Calories</th><th>Macros</th><th>Details</th></tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr data-log-date="{{ log.local_created|date:'Y-m-d' }}" data-meal-name="{{ log.meal_name|lower }}">
                    <td>{{ log.created_at|timezone:'Asia/Kolkata'|date:'Y-m-d h:i A T' }}</td>
                    <td>{{ log.computed_icon }} {{ log.meal_name }} <span class="muted-small">Â· {{ log.computed_type }}</span></td>
                    <td>{{ log.calories }} kcal</td>
                    <td>{{ log.protein_g }} g â€¢ {{ log.fat_g }} g â€¢ {{ log.carbs_g }} g</td>
                    <td><button class="showItems">Show</button></td>
                </tr>
                <tr class="details" style="display:none">
                    <td colspan="5">
                        {% if log.items_json %}
                            <div class="log-details" data-items-json='{{ log.items_json|escapejs }}'></div>
                        {% else %}
                            <span class="muted">No details</span>
                        {% endif %}
                    </td>
                </tr>                                
                {% empty %}
                <tr><td colspan="5" class="muted">No logs found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function applyFilters(){
        const d = document.getElementById('filterDate').value;
        const q = document.getElementById('q').value.toLowerCase().trim();
        document.querySelectorAll('#logsTable tbody tr').forEach(tr=>{
            if(tr.classList.contains('details')) return;
            const date = tr.getAttribute('data-log-date');
            const name = tr.getAttribute('data-meal-name') || '';
            let ok = true;
            if(d && date !== d) ok = false;
            if(q && !name.includes(q)) ok = false;
            tr.style.display = ok ? '' : 'none';
            // Always keep the details row hidden when applying filters so the "Show" button
            // consistently controls visibility (avoids appearing to 'not work')
            const detail = tr.nextElementSibling; if(detail && detail.classList.contains('details')) detail.style.display = 'none';
            // Ensure the toggle button text resets to 'Show' so behavior is consistent after filtering
            const btn = tr.querySelector('.showItems'); if(btn) btn.textContent = 'Show';
        });
        document.getElementById('count').textContent = document.querySelectorAll('#logsTable tbody tr:not(.details):not([style*="display:none"])').length;
    }
    function clearFilters(){ document.getElementById('filterDate').value = ''; document.getElementById('q').value=''; applyFilters(); }
    // toggle details rows and render formatted items on demand
    document.querySelectorAll('.showItems').forEach(b=> b.addEventListener('click', function(){
        const tr = this.closest('tr');
        const det = tr.nextElementSibling;
        if(!det) return;
        // if showing now, populate the details if not yet done
        const willShow = (det.style.display === 'none' || getComputedStyle(det).display === 'none');
        if(willShow){
            const container = det.querySelector('.log-details');
            if(container && !container.dataset.rendered){
                try{
                    const raw = container.getAttribute('data-items-json') || '[]';

                    // Robust parsing: handle normal JSON, double-encoded JSON (stringified twice),
                    // and common escaped unicode sequences like \u0022 produced by escapejs.
                    function tryParse(s){
                        try{ let v = JSON.parse(s); if(typeof v === 'string'){ try{ v = JSON.parse(v); }catch(_){} } return v; }catch(e){}
                        try{ const replaced = s.replace(/\\u0022/g,'"'); let v = JSON.parse(replaced); if(typeof v === 'string'){ try{ v = JSON.parse(v); }catch(_){} } return v; }catch(e){}
                        try{ return JSON.parse(JSON.parse(s)); }catch(e){}
                        return null;
                    }

                    function unescapeReadable(s){
                        try{
                            return s.replace(/\\u([0-9a-fA-F]{4})/g, function(_,m){ return String.fromCharCode(parseInt(m,16)); })
                                    .replace(/\\n/g,'\n').replace(/\\"/g,'"').replace(/\\\\/g,'\\');
                        }catch(e){ return s; }
                    }

                    const items = tryParse(raw);
                    if(Array.isArray(items) && items.length){
                        const table = document.createElement('table');
                        const thead = document.createElement('thead');
                        thead.innerHTML = '<tr><th>Food</th><th style="width:72px">g</th><th>Calories</th><th>Protein</th><th>Fat</th><th>Carbs</th><th>Fiber</th></tr>';
                        table.appendChild(thead);
                        const tbody = document.createElement('tbody');
                        items.forEach(it=>{
                            const r = document.createElement('tr');
                            const calories = it.nutrition && (it.nutrition.calories || it.nutrition.calories === 0) ? (it.nutrition.calories + ' kcal') : 'â€”';
                            const protein = it.nutrition && (it.nutrition.protein_g || it.nutrition.protein_g === 0) ? (it.nutrition.protein_g + ' g') : 'â€”';
                            const fat = it.nutrition && (it.nutrition.fat_g || it.nutrition.fat_g === 0) ? (it.nutrition.fat_g + ' g') : 'â€”';
                            const carbs = it.nutrition && (it.nutrition.carbs_g || it.nutrition.carbs_g === 0) ? (it.nutrition.carbs_g + ' g') : 'â€”';
                            const fiber = it.nutrition && (it.nutrition.fiber_g || it.nutrition.fiber_g === 0) ? (it.nutrition.fiber_g + ' g') : 'â€”';
                            r.innerHTML = '<td>'+ (it.food || 'â€”') + '</td>'+
                                          '<td>'+ (it.grams || 'â€”') + '</td>'+
                                          '<td>'+ calories + '</td>'+
                                          '<td>'+ protein + '</td>'+
                                          '<td>'+ fat + '</td>'+
                                          '<td>'+ carbs + '</td>'+
                                          '<td>'+ fiber + '</td>';
                            tbody.appendChild(r);
                        });
                        table.appendChild(tbody);
                        container.appendChild(table);
                    } else if(items && typeof items === 'object'){
                        // single object or keyed object â€” pretty-print
                        container.innerHTML = '<pre>'+ JSON.stringify(items, null, 2) +'</pre>';
                    } else {
                        const rawText = container.getAttribute('data-items-json') || '';
                        container.innerHTML = '<pre>'+ unescapeReadable(rawText) +'</pre>';
                        console.warn('Failed to parse items_json for log; showing raw content');
                    }
                }catch(e){
                    // final fallback: show raw readable text
                    const rawText = container.getAttribute('data-items-json') || '';
                    container.innerHTML = '<pre>'+ rawText +'</pre>';
                    console.warn('Unexpected error rendering log details', e);
                }
                container.dataset.rendered = '1';
            }
        }
        det.style.display = willShow ? '' : 'none';
        // Update the clicked button label to reflect current state
        this.textContent = willShow ? 'Hide' : 'Show';
    }));
    // CSV export
    document.getElementById('exportCsv').addEventListener('click', function(){
        const rows = [['created_at','meal_name','calories','protein_g','fat_g','carbs_g']];
        document.querySelectorAll('#logsTable tbody tr').forEach((tr)=>{
            if(tr.classList.contains('details')) return;
            if(tr.style.display==='none') return;
            const cells = tr.querySelectorAll('td');
            const date = cells[0].textContent.trim();
            // sanitize meal name (remove emoji and trailing ' Â· type')
            let mealText = cells[1].textContent.trim();
            mealText = mealText.replace(/[\u{1F300}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').replace(/\s*Â·\s*.*$/, '').trim();
            const calories = cells[2].textContent.replace(' kcal','').trim();
            const macrosText = cells[3].textContent.trim();
            const parts = macrosText.split('â€¢').map(p=>p.trim());
            const protein = parts[0] ? parts[0].replace(/ g$/,'') : '';
            const fat = parts[1] ? parts[1].replace(/ g$/,'') : '';
            const carbs = parts[2] ? parts[2].replace(/ g$/,'') : '';
            rows.push([date, mealText, calories, protein, fat, carbs]);
        });
        const csv = rows.map(r => r.map(c=> '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download='meal_logs.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
</script>
<script>
(function(){
        try{
                const pBtn = document.getElementById('profileBtn');
                const pDrop = document.getElementById('profileDropdown');
                if(pBtn){
                        pBtn.addEventListener('click', function(ev){ ev.stopPropagation(); const opened = pBtn.getAttribute('aria-expanded') === 'true'; pBtn.setAttribute('aria-expanded', String(!opened)); pDrop.style.display = opened ? 'none' : 'block'; });
                        document.addEventListener('click', function(){ if(pDrop){ pDrop.style.display = 'none'; pBtn.setAttribute('aria-expanded','false'); } });
                }
        }catch(e){ console.warn('profile menu init', e); }
})();
</script>


<script>
(function(){
    try{
        const b = document.querySelector('.streak-badge[data-count]');
        if(!b) return;
        b.style.background = b.dataset.color || b.style.background;
        const cur = Number(b.dataset.count || 0);
        const key = 'fn_last_streak';
        const prev = Number(localStorage.getItem(key) || 0);
        if(cur > prev && prev >= 0){ b.classList.add('streak-increment'); setTimeout(()=>b.classList.remove('streak-increment'), 1400); }
        localStorage.setItem(key, String(cur));
    }catch(e){console.warn('streak init',e)}
})();
</script>
</body>
</html>