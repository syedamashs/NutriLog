<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NutriLog - Dashboard</title>
    <link rel="icon" type="image/png" href="/data/nutrilog_logo.png">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg: #071024; /* deep slate */
            --card: #071022;
            --muted: #9fb3d9;
            --accent: linear-gradient(135deg,#00c6ff 0%,#0072ff 100%); /* vibrant cyan-blue */
            --accent-solid: #00b4ff;
            --accent-2: linear-gradient(135deg,#7b61ff 0%,#ff6bd6 100%); /* purple-pink */
            --glass: rgba(255,255,255,0.03);
            --glass-2: rgba(255,255,255,0.02);
        }

        *{box-sizing:border-box}
        body{
            margin:0;
            font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: radial-gradient(1200px 500px at 10% 10%, rgba(99,102,241,0.08), transparent 8%),
                        linear-gradient(180deg, #071024 0%, #071a2e 100%);
            color:#e6eef8;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            padding:36px;
        }

        .app {
            max-width:1100px;
            margin:0 auto;
        }

        header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:20px;
            margin-bottom:18px;
        }

        .brand{
            display:flex;align-items:center;gap:12px
        }
        .logo{width:64px;height:64px;border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:0 8px 28px rgba(0,0,0,0.28);border:1px solid rgba(255,255,255,0.03);transition:transform .32s cubic-bezier(.2,.9,.3,1);cursor:pointer}
        .logo img{width:100%;height:100%;object-fit:cover;display:block}
        .logo-fallback{font-weight:900;font-size:18px}
        .logo:hover{transform:translateY(-8px) scale(1.22) rotate(-8deg)}
        .title{font-size:18px;font-weight:700}
        .subtitle{color:var(--muted);font-size:13px}

        /* NutriLog modal (click logo to open) */
        .fn-modal-overlay{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(4,10,20,0.55);backdrop-filter:blur(6px);z-index:9999}
        .fn-modal-overlay.show{display:flex}
        .fn-modal-card{width:min(520px,92%);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:22px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 60px rgba(2,6,23,0.7);color:#e6eef8;position:relative;transform:scale(.95);opacity:0;transition:transform .28s cubic-bezier(.2,.9,.3,1),opacity .18s}
        .fn-modal-overlay.show .fn-modal-card{transform:scale(1);opacity:1}
        .fn-modal-close{position:absolute;right:10px;top:10px;background:transparent;border:none;color:#e6eef8;font-size:18px;cursor:pointer}
        .fn-modal-logo{display:flex;align-items:center;gap:12px}
        .fn-modal-logo img{width:86px;height:86px;object-fit:cover;border-radius:10px}
        .fn-modal-title{font-size:18px;font-weight:800;margin-top:6px}
        .fn-modal-desc{color:var(--muted);margin-top:6px}
        .fn-modal-actions{display:flex;gap:10px;margin-top:18px;align-items:center}
        .fn-btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
        .fn-btn.glow{background:linear-gradient(90deg,#ff7a9a,#ffd6a5);color:#071028;box-shadow:0 8px 30px rgba(255,122,154,0.18);}
        .fn-btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)}
        .fn-modal-credits{display:none}
        .fn-modal-credits.show{display:block}
        .fn-modal-credits ul{margin:8px 0 0 18px}
        .fn-modal-footer{margin-top:14px;display:flex;gap:8px;align-items:center}
        .fn-github{padding:8px 12px;border-radius:8px;background:#111827;color:#fff;text-decoration:none;display:inline-block}
        
        /* Goal modal (celebration) */
        .goal-overlay{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(4,10,20,0.6);backdrop-filter:blur(6px);z-index:10010}
        .goal-overlay.show{display:flex}
        .goal-card{width:min(420px,92%);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:22px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 60px rgba(2,6,23,0.7);color:#e6eef8;position:relative;transform:translateY(-6px);opacity:0;transition:transform .28s cubic-bezier(.2,.9,.3,1),opacity .18s}
        .goal-overlay.show .goal-card{transform:translateY(0);opacity:1}
        .goal-close{position:absolute;right:10px;top:10px;background:transparent;border:none;color:#e6eef8;font-size:18px;cursor:pointer}
        .goal-emoji{font-size:46px;text-align:center;margin-top:6px}
        .goal-title{text-align:center;font-size:18px;font-weight:800;margin-top:8px}
        .goal-desc{text-align:center;color:var(--muted);margin-top:6px}
        .goal-stats{text-align:center;color:var(--muted);margin-top:8px}
        /* confetti/sparks */
        .goal-confetti{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none}
        .goal-confetti .spark{position:absolute;left:50%;top:40%;width:10px;height:10px;border-radius:50%;opacity:0;transform:translate(-50%,-50%)}
        .goal-confetti .spark.s1{background:#ff7a9a;--tx:-70px;--ty:-40px;--delay:0s}
        .goal-confetti .spark.s2{background:#ffd6a5;--tx:60px;--ty:-50px;--delay:0.03s}
        .goal-confetti .spark.s3{background:#7b61ff;--tx:-40px;--ty:60px;--delay:0.06s}
        .goal-confetti .spark.s4{background:#ffcc5c;--tx:40px;--ty:70px;--delay:0.09s}
        .goal-confetti .spark.s5{background:#ff6bd6;--tx:-20px;--ty:-80px;--delay:0.12s}
        .goal-confetti .spark.s6{background:#00b4ff;--tx:80px;--ty:-20px;--delay:0.15s}
        .goal-confetti .spark.s7{background:#ffd1e6;--tx:-90px;--ty:20px;--delay:0.18s}
        .goal-confetti .spark.s8{background:#90f7ec;--tx:90px;--ty:30px;--delay:0.21s}
        @keyframes spark-burst{0%{opacity:1;transform:translate(-50%,-50%) scale(1)}70%{opacity:1;transform:translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(.9) rotate(45deg)}100%{opacity:0;transform:translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(.7) rotate(90deg)}}
        .goal-confetti .spark{animation:spark-burst .9s cubic-bezier(.2,.9,.2,1) both;animation-delay:var(--delay)}

        /* profile avatar and dropdown */
        .profile-menu{position:relative}
        .profile-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(90deg,#ffd6a5,#ff7a9a);display:inline-flex;align-items:center;justify-content:center;color:#071028;font-weight:800;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
        .profile-avatar .initial{font-weight:900}
        .profile-dropdown{position:absolute;right:0;top:48px;background:#071022;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;min-width:140px;display:none;z-index:999}
        .profile-dropdown a{display:block;padding:8px;color:#e6eef8;text-decoration:none;border-radius:6px}
        /* Unified dropdown hover styles (match profile) */
        .profile-dropdown a:hover{background:rgba(0,180,255,0.12);color:#ffffff;font-weight:700}
        .muted-btn:hover{background:rgba(0,180,255,0.08);color:#00b4ff;border-color:rgba(0,180,255,0.85)}
        .range-btn:hover{background:rgba(0,180,255,0.06);color:#00b4ff}
        /* Select styling */
        select{background:rgba(255,255,255,0.02);color:#e6eef8;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px}
        select:focus{outline:2px solid rgba(0,180,255,0.12);box-shadow:0 6px 18px rgba(0,180,255,0.06) ;}
        select option{background:#071022;color:#e6eef8} 

        nav{display:flex;gap:12px;align-items:center}
        .btn, .muted-btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
        .btn{background:linear-gradient(90deg,#ff7a9a,#ffb199);color:#071028}
        .muted-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
        /* Large button modifier: increase size without changing hover */
        .btn.large-btn{font-size:16px;padding:13px 17px;border-radius:12px}

        .grid {
            display:grid;
            grid-template-columns: 1fr; /* single-column full page flow */
            gap:20px;
            align-items:start;
            margin-top:18px;
        }

       /* upload preview and status */
       .upload-preview{display:none;margin-top:12px;align-items:center;gap:12px}
       .upload-preview img{width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,0.04)}
       .file-meta{font-size:13px;color:var(--muted)}
       .remove-file-btn{background:transparent;border:none;color:#ff8b8b;cursor:pointer;font-weight:700;padding:6px}

       /* Camera modal for real-time capture */
       .camera-modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(4,10,20,0.8);display:none;align-items:center;justify-content:center;z-index:9999}
       .camera-modal.show{display:flex}
       .camera-card{width:min(720px,96%);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 60px rgba(2,6,23,0.7);color:#e6eef8}
       .camera-card video{width:100%;height:auto;border-radius:8px;background:#000}
       .camera-actions{display:flex;gap:8px;justify-content:center;margin-top:10px}
       .camera-actions .btn{padding:8px 12px}

       /* stacked right panel spacing once grid is single-column */
       .right-panel{position:relative;margin-top:10px}

        /* LEFT PANEL */
        .panel{
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border-radius:14px;padding:20px;border:1px solid rgba(255,255,255,0.03);
            box-shadow: 0 10px 30px rgba(2,6,23,0.6);
        }

        .upload-area{
            border:1px dashed rgba(255,255,255,0.06);
            padding:28px;border-radius:12px;background:var(--glass);
            display:flex;align-items:center;gap:18px;flex-wrap:wrap
        }

        .upload-info{flex:1}
        .upload-title{font-weight:700}
        .upload-desc{color:var(--muted);font-size:13px;margin-top:6px}

        input[type=file]{display:none}
        .file-btn{padding:10px 14px;border-radius:10px;background:#0b1227;border:1px solid rgba(255,255,255,0.04);color:#fff;cursor:pointer}

        .stats{
            display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;margin-top:18px
        }
        .stat{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,0.02)}
        .stat h4{margin:0;font-size:12px;color:var(--muted)}
        .stat p{margin:6px 0 0;font-size:18px;font-weight:700}

        /* DETECTED ITEMS */
        .detected-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:18px}
        .detected-card{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);}
        .detected-card .name{font-weight:700}
        .detected-card input{width:100%;padding:8px;margin-top:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}

        /* RIGHT PANEL */
        .right-panel{position:relative}
        .card-hero{padding:18px;border-radius:12px;background:linear-gradient(90deg,#0b1227,#071028);border:1px solid rgba(255,255,255,0.03)}
        .macro-grid{display:flex;gap:10px;margin-top:12px}
        .macro{flex:1;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;text-align:center}
        .macro h5{margin:0;font-size:12px;color:var(--muted)}
        .macro p{margin:8px 0 0;font-size:18px;font-weight:800}

        canvas{max-width:100%}

        /* Nutrition results */
        .results{margin-top:18px}
        .result-item{display:flex;align-items:center;justify-content:space-between;padding:14px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);margin-bottom:10px}
        .result-item strong{font-weight:700}
        .progress{height:8px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden;margin-top:8px}
        .progress > i{display:block;height:100%;background:linear-gradient(90deg,#ff7a9a,#ffd6a5)}

        footer{margin-top:28px;color:var(--muted);text-align:center;font-size:13px}

        /* responsive */
        /* transition and hover behavior handled with the main .logo block above (larger hover effect) */

        .left-charts{margin-top:18px}
        .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
        .chart-card{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);min-height:140px;display:flex;align-items:center;justify-content:center}
        .chart-card canvas{width:100%;height:120px}

        /* Streak badge (compact, matching other pages) */
        .streak-badge{display:inline-grid;place-items:center;width:40px;height:40px;border-radius:8px;font-weight:900;color:#fff;font-size:16px;box-shadow:0 6px 14px rgba(0,0,0,0.34);position:relative;padding:4px 8px 4px 8px;text-decoration:none;z-index:10;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
        /* Flame anchored in corner and slightly larger so it's prominent but not overlapping */
        .streak-badge .streak-fire{position:absolute;left:4px;top:6px;font-size:14px;filter:drop-shadow(0 1px 4px rgba(0,0,0,0.12));line-height:1;z-index:13}
        /* Ensure number is readable and pushed right of flame */
        .streak-badge .streak-num{font-size:16px;font-weight:900;color:#071028;margin-left:6px;position:relative;z-index:12}
        /* Dashboard modifier: slightly larger for home page */
        .streak-badge--home{width:64px;height:64px;border-radius:12px;font-size:20px;background:var(--accent-solid);color:#071028;z-index:20}
        .streak-badge--home .streak-fire{font-size:20px}
        .streak-badge--home .streak-num{font-size:20px}
        .streak-increment{animation:streak-pop .95s cubic-bezier(.2,.9,.2,1)}
        @keyframes streak-pop{0%{transform:scale(1);opacity:1}40%{transform:scale(1.28);opacity:1}100%{transform:scale(1);opacity:1}}

        body.light{
            background: linear-gradient(180deg,#f7fbff 0%,#ffffff 100%);
            color:#071028;
        }
        body.light .panel, body.light .card-hero{
            background: linear-gradient(180deg,#fff,#f7fbff);
            color:#071028;
            border:1px solid rgba(7,16,36,0.04);
        }
        body.light .muted-btn{background:transparent;border:1px solid rgba(7,16,36,0.06);color:#071028}
        body.light .btn{color:#071028}

        @media (max-width:980px){
            .grid{grid-template-columns:1fr}
            .stats{grid-template-columns:repeat(2,1fr)}
            .charts-grid{grid-template-columns:1fr}
        }

    </style> 
</head>
<body>
<div class="app">
    <header>
        <div class="brand">
            <div class="logo"><img src="/data/nutrilog_logo.png" alt="NutriLog" onerror="this.style.display='none'; this.parentElement.querySelector('.logo-fallback').style.display='flex'"/><div class="logo-fallback" style="display:none;align-items:center;justify-content:center;width:100%;height:100%;font-weight:800;color:#fff">NL</div></div>
            <div>
                <div class="title">NutriLog</div>
                <div class="subtitle">Eat Smart. Track Better.</div>
            </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px">
            {% if user.is_authenticated %}
                <div style="display:flex;align-items:center;gap:10px">
                    <div style="font-size:12px;color:var(--muted)">Streak</div>
                    <a href="/analytics/logs/" style="text-decoration:none">
                        <div class="streak-badge" data-count="{{ streak.count }}" data-color="{{ streak.color }}" role="img" aria-label="{{ streak.count }} day streak">
                            <span class="streak-fire">üî•</span>
                            <span class="streak-num">{{ streak.count }}</span>
                        </div>
                    </a>
                </div>
            {% endif %}

            <nav>
                {% if user.is_authenticated %}
                    <a href="/history/" class="muted-btn" style="text-decoration: none;">Analytics</a>
                {% else %}
                    <a href="/login/" class="muted-btn">Login</a>
                    <a href="/register/" class="muted-btn">Register</a>
                {% endif %}
            </nav>
            {% if user.is_authenticated %}
            <div class="profile-menu">
                <button id="profileBtn" class="profile-avatar" aria-haspopup="true" aria-expanded="false" title="{{ user.username }}">
                    <span class="initial">{{ user.username|slice:":1"|upper }}</span>
                </button>
                <div class="profile-dropdown" id="profileDropdown" role="menu">
                    <a href="/profile/">View profile</a>
                    <a href="/logout/">Logout</a>
                </div>
            </div>
            {% endif %} 
        </div>
    </header>

    <main class="grid">
        <!-- Left: Upload + Detection -->
        <section class="panel">
            <h3 style="margin:0 0 10px">Upload Food Image</h3>

            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
            <div class="upload-area" id="uploadArea">
                <div class="upload-info">
                    <div class="upload-title">Drop an image or click <strong>Upload Food</strong></div>
                    <div class="upload-desc">High-quality photos yield better detection. Try top-down shots of the plate.</div>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                    <button type="button" class="btn large-btn" id="cameraBtn">üì∑ Camera</button>
                    <button type="button" class="btn large-btn" id="scanBtn">Upload Food</button>
                </div>
            </div>
            <input type="file" name="image" id="imageInput" accept="image/*" required style="position:absolute;left:-9999px;" aria-hidden="true">
            <div id="uploadPreview" class="upload-preview">
                <img id="uploadThumb" src="" alt="preview">
                <div style="display:flex;flex-direction:column">
                    <div class="file-meta" id="fileName">No file selected</div>
                    <div class="file-meta" id="fileSize"></div>
                </div>
                <div style="margin-left:auto">
                    <button type="button" id="removeFile" class="remove-file-btn">Remove</button>
                </div>
            </div>
            <div id="uploadStatus" style="margin-top:8px;color:var(--muted);font-size:13px"></div>                {% if scan_error %}
                    <div style="margin-top:8px;color:#ff6b6b;font-weight:700">Scan failed: {{ scan_error }}</div>
                {% endif %}

            <!-- Daily goal reached modal (hidden unless triggered) -->
            <div id="goalModal" class="goal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
                <div class="goal-card">
                    <button id="goalModalClose" class="goal-close" aria-label="Close">‚úï</button>
                    <div class="goal-emoji">üéâ</div>
                    <h3 class="goal-title">Daily Goal Reached!</h3>
                    <div class="goal-desc">Great job ‚Äî you've met your daily target.</div>
                    <div class="goal-stats">Total: <strong>{% if goal_total %}{{ goal_total|floatformat:2 }}{% else %}‚Äî{% endif %} kcal</strong> ‚Ä¢ Goal: <strong>{% if goal_val %}{{ goal_val|floatformat:2 }}{% else %}‚Äî{% endif %} kcal</strong></div>
                    <div class="goal-confetti" aria-hidden="true">
                        <span class="spark s1"></span>
                        <span class="spark s2"></span>
                        <span class="spark s3"></span>
                        <span class="spark s4"></span>
                        <span class="spark s5"></span>
                        <span class="spark s6"></span>
                        <span class="spark s7"></span>
                        <span class="spark s8"></span>
                    </div>
                </div>
            </div>

            {% if goal_reached %}
            <script>
                (function(){
                    const modal = document.getElementById('goalModal');
                    if(!modal) return;
                    modal.setAttribute('aria-hidden','false');
                    modal.classList.add('show');
                    const close = () => { modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); };
                    document.getElementById('goalModalClose').addEventListener('click', close);
                    // Auto close after 5s
                    setTimeout(close, 5000);
                })();
            </script>
            {% endif %}
            <!-- Camera modal for live capture -->
            <div id="cameraModal" class="camera-modal" role="dialog" aria-hidden="true">
                <div class="camera-card">
                    <video id="cameraVideo" autoplay playsinline></video>
                    <div class="camera-actions">
                        <button type="button" id="captureBtn" class="btn">Capture</button>
                        <button type="button" id="cancelCamBtn" class="muted-btn">Cancel</button>
                    </div>
                </div>
            </div>

            </form>



            <!-- STEP 2: ASK WEIGHT FOR EACH DETECTED ITEM -->
            {% if detected_items %}
            <div class="detected-block" style="margin-top:18px">
                <h4 style="margin-bottom:8px">Detected Items <span style="color:var(--muted);font-size:13px">({{ detected_items|length }})</span></h4>
                <div style="color:var(--muted);font-size:13px;margin-bottom:8px">Tip: leave empty if it's not your dish ‚Äî only filled weights are counted.</div>
                <div class="detected-list">
                    <form method="post" id="weightsForm">
                        {% csrf_token %}
                        <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
                            <label style="font-weight:700">Meal type</label>
                            <select name="meal_type" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff">
                                <option value="Auto" selected>Auto (by time)</option>
                                <option value="Breakfast">Breakfast</option>
                                <option value="Lunch">Lunch</option>
                                <option value="Dinner">Dinner</option>
                                <option value="Snack">Snack</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        {% for item in detected_items %}
                            <div class="detected-card">
                                <div class="name">{{ item }}</div>
                                <input type="hidden" name="detected_items" value="{{ item }}">
                                <input type="number" name="grams_{{ item }}" placeholder="grams">
                            </div>
                        {% endfor %}
                        <div style="grid-column:1/-1;margin-top:12px">
                            <button type="submit" class="btn" id="viewNutritionBtn">View Nutrition</button>
                        </div>
                    </form>
                </div>
            </div>
            {% elif detected_items is not None %}
                <div style="margin-top:16px;color:var(--muted);font-size:13px">No food detected ‚Äî try a clearer photo or different angle.</div>
            {% endif %}

            <div class="left-charts">
                <h4 style="margin-bottom:8px">Quick Insights</h4>
                <div class="charts-grid">
                    <div class="chart-card" style="grid-column:1/-1">
                        <canvas id="itemCalChart"></canvas>
                    </div>
                </div> 
            </div>

        </section> 

        <!-- Right: Summary + Chart -->
        <aside class="right-panel">
            <div class="card-hero">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
                    <div>
                        <h3 style="margin:0">Today's Meal</h3>
                        <div style="color:var(--muted);font-size:13px;margin-top:6px">Summary for the selected image</div>
                    </div>
                    <div style="width:140px">
                        <canvas id="macroChart"></canvas>
                    </div>
                </div>

                <div class="macro-grid" style="margin-top:8px">
                    <div class="macro">
                        <h5>Calories</h5>
                        <p id="caloriesVal">‚Äî</p>
                    </div>
                    <div class="macro">
                        <h5>Protein</h5>
                        <p id="proteinVal">‚Äî</p>
                    </div>
                    <div class="macro">
                        <h5>Fat</h5>
                        <p id="fatVal">‚Äî</p>
                    </div>
                </div>

                <div class="results">
                    {% if items %}
                        <h4 style="margin-bottom:8px">Nutrition per Item</h4>
                        {% for item in items %}
                        <div class="result-item">
                            <div>
                                <div><strong>{{ item.food }}</strong> ‚Ä¢ <span style="color:var(--muted)">{{ item.grams }} g</span></div>

                            </div>
                            <div style="text-align:right">
                                <div style="font-size:14px;color:var(--muted)">Calories</div>
                                <div style="font-weight:800">{{ item.nutrition.calories }} kcal</div>
                            </div>
                        </div>
                        {% endfor %}

                        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:14px 0;">

                        <h4 style="margin-bottom:8px">Total Nutrition</h4>
                        <div class="result-item">
                            <div><strong>Total Calories</strong></div>
                            <div style="font-weight:800">{{ total.calories }} kcal</div>
                        </div>
                        <div class="result-item">
                            <div><strong>Protein</strong></div>
                            <div style="font-weight:800">{{ total.protein_g }} g</div>
                        </div>
                        <div class="result-item">
                            <div><strong>Fat</strong></div>
                            <div style="font-weight:800">{{ total.fat_g }} g</div>
                        </div>
                        <div class="result-item">
                            <div><strong>Carbs</strong></div>
                            <div style="font-weight:800">{{ total.carbs_g }} g</div>
                        </div>
                        <div class="result-item">
                            <div><strong>Fiber</strong></div>
                            <div style="font-weight:800">{{ total.fiber_g }} g</div>
                        </div>

                        <div style="margin-top:12px">
                            <button id="downloadCsv" class="muted-btn">Download Nutrition (CSV)</button>
                        </div>
                    {% else %}
                        <div style="color:var(--muted);font-size:13px">No nutrition calculated yet ‚Äî scan an image and enter weights to get started.</div>
                    {% endif %}
                </div>

            </div>
        </aside>

    </main>

    <footer>¬© NutriLog ‚Ä¢ Django</footer>
</div>

<!-- Floating debug panel (captures window errors & console.error for quick debugging) -->
<div id="debugWrapper" style="position:fixed;left:14px;bottom:14px;z-index:9999;">
    <button id="debugBtn" title="Show debug logs" style="background:#1b2430;color:#fff;padding:8px 10px;border-radius:10px;border:none;box-shadow:0 8px 18px rgba(2,6,23,0.6);cursor:pointer">üêû Debug <span id="debugCount" style="margin-left:8px;background:#ff5d5d;color:#fff;padding:2px 6px;border-radius:999px;font-size:12px;display:inline-block">0</span></button>
    <div id="debugPanel" style="display:none;min-width:360px;max-width:520px;max-height:360px;overflow:auto;background:rgba(0,0,0,0.85);color:#fff;padding:12px;border-radius:10px;margin-top:8px;font-family:monospace;font-size:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong>Client Logs</strong>
            <div>
                <button id="debugCopy" style="margin-right:8px;padding:6px;border-radius:8px;border:none;cursor:pointer">Copy</button>
                <button id="debugClear" style="padding:6px;border-radius:8px;border:none;cursor:pointer">Clear</button>
            </div>
        </div>
        <div id="debugList"></div>
    </div>
</div>

<!-- Chart.js CDN -->
<script id="dashboard-data" type="application/json">
{
  "total": {
    "grams": {{ total.grams|default:0 }},
    "calories": {{ total.calories|default:0 }},
    "protein": {{ total.protein_g|default:0 }},
    "fat": {{ total.fat_g|default:0 }},
    "carbs": {{ total.carbs_g|default:0 }},
    "fiber": {{ total.fiber_g|default:0 }}
  },

  "items": [
    {% for item in items %}
    {
      "food": "{{ item.food|escapejs }}",
      "grams": {{ item.grams|default:0 }},
      "calories": {{ item.nutrition.calories|default:0 }},
      "protein": {{ item.nutrition.protein_g|default:0 }},
      "fat": {{ item.nutrition.fat_g|default:0 }},
      "carbs": {{ item.nutrition.carbs_g|default:0 }},
      "fiber": {{ item.nutrition.fiber_g|default:0 }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Small client-side interactions
    (function(){
        const chooseBtn = document.getElementById('chooseBtn');
        const imageInput = document.getElementById('imageInput');
        const scanBtn = document.getElementById('scanBtn');
        const uploadPreview = document.getElementById('uploadPreview');
        const uploadThumb = document.getElementById('uploadThumb');
        const fileNameEl = document.getElementById('fileName');
        const fileSizeEl = document.getElementById('fileSize');
        const removeBtn = document.getElementById('removeFile');
        const uploadStatus = document.getElementById('uploadStatus');

        if(imageInput && scanBtn){
            // Small on-screen toast helper
            function showToast(msg, timeout){
                try{
                    const t = document.getElementById('toast');
                    if(!t) return;
                    t.textContent = msg || '';
                    t.style.display = 'block';
                    setTimeout(function(){ t.style.display = 'none'; }, timeout || 3000);
                }catch(e){ console.warn('toast error', e); }
            }

            // Make Scan button open the file picker with debug + UX feedback
            scanBtn.addEventListener('click', function(){
                try{
                    console.log('scanBtn clicked');
                    if(!imageInput){ console.warn('imageInput missing'); showToast('File input missing'); return; }
                    scanBtn.textContent = 'Select image‚Ä¶';
                    imageInput.click();
                    showToast('Opening file picker...');
                    setTimeout(function(){ scanBtn.textContent = 'Upload Food'; }, 4000);
                }catch(err){ console.error('Error opening file picker', err); showToast('Could not open file selector'); }
            });

            function formatBytes(bytes){ if(bytes<1024) return bytes+' B'; if(bytes<1048576) return (bytes/1024).toFixed(1)+' KB'; return (bytes/1048576).toFixed(1)+' MB'; }
            function showPreview(file){
                if(!file){ uploadPreview.style.display = 'none'; fileNameEl.textContent='No file selected'; fileSizeEl.textContent=''; uploadThumb.src=''; uploadStatus.textContent=''; return; }
                uploadPreview.style.display = 'flex';
                fileNameEl.textContent = file.name;
                fileSizeEl.textContent = formatBytes(file.size);
                const reader = new FileReader();
                reader.onload = function(e){ uploadThumb.src = e.target.result || ''; };
                reader.readAsDataURL(file);
                uploadStatus.textContent = 'Ready to scan';
            }

            imageInput.addEventListener('change', function(){
                try{
                    console.log('imageInput change event - files:', imageInput.files && imageInput.files.length);
                    const f = imageInput.files && imageInput.files[0];
                    showPreview(f);
                    if(f){
                        showToast('File selected, uploading...');
                        // Auto-submit the form once a file is chosen
                        if(uploadForm){
                            setTimeout(function(){ uploadForm.submit(); }, 250);
                        }else{
                            console.warn('uploadForm not found'); showToast('Upload form missing');
                        }
                    }
                }catch(e){ console.error('Error handling image selection', e); showToast('Error selecting file'); }
            });

            removeBtn && removeBtn.addEventListener('click', function(){
                imageInput.value = '';
                showPreview(null);
                scanBtn.disabled = true;
            });
            // start state
            showPreview(imageInput.files && imageInput.files[0] || null);

            // Camera capture: open modal, stream, capture frame and submit as file
            const cameraBtn = document.getElementById('cameraBtn');
            const cameraModal = document.getElementById('cameraModal');
            const cameraVideo = document.getElementById('cameraVideo');
            const captureBtn = document.getElementById('captureBtn');
            const cancelCamBtn = document.getElementById('cancelCamBtn');
            let cameraStream = null;

            async function openCamera(){
                try{
                    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ showToast('Camera not supported'); return; }
                    cameraModal.classList.add('show'); cameraModal.setAttribute('aria-hidden','false');
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                    cameraVideo.srcObject = cameraStream;
                    cameraVideo.play();
                }catch(e){ console.error('Could not open camera', e); showToast('Camera access denied or not available'); cameraModal.classList.remove('show'); cameraModal.setAttribute('aria-hidden','true'); }
            }
            function closeCamera(){
                try{ if(cameraStream){ cameraStream.getTracks().forEach(t=>t.stop()); cameraStream = null; } cameraVideo.srcObject = null; cameraModal.classList.remove('show'); cameraModal.setAttribute('aria-hidden','true'); }catch(e){console.warn('Error closing camera', e)}
            }
            cameraBtn && cameraBtn.addEventListener('click', function(){ openCamera(); });
            cancelCamBtn && cancelCamBtn.addEventListener('click', function(){ closeCamera(); });
            captureBtn && captureBtn.addEventListener('click', async function(){
                try{
                    // draw current frame to canvas
                    const w = cameraVideo.videoWidth || 1280; const h = cameraVideo.videoHeight || 720;
                    const c = document.createElement('canvas'); c.width = w; c.height = h;
                    const ctx = c.getContext('2d'); ctx.drawImage(cameraVideo, 0, 0, w, h);
                    // get blob
                    const dataUrl = c.toDataURL('image/jpeg', 0.9);
                    // convert dataURL to blob
                    const res = await fetch(dataUrl); const blob = await res.blob();
                    const file = new File([blob], ('capture-'+Date.now()+'.jpg'), { type: 'image/jpeg' });
                    // set file into imageInput using DataTransfer
                    try{
                        const dt = new DataTransfer(); dt.items.add(file); imageInput.files = dt.files;
                        showPreview(file);
                        showToast('Captured image, uploading...');
                        closeCamera();
                        if(uploadForm){ setTimeout(()=> uploadForm.submit(), 250); }
                    }catch(e){ console.error('Error setting captured file', e); showToast('Capture failed'); }
                }catch(e){ console.error('Capture failed', e); showToast('Capture failed'); }
            });
        }

        // show uploading state when the form is submitted
        const uploadForm = document.getElementById('uploadForm');
        if(uploadForm){
            uploadForm.addEventListener('submit', function(){
                if(scanBtn){ scanBtn.disabled = true; scanBtn.textContent = 'Uploading‚Ä¶'; uploadStatus.textContent = 'Uploading image‚Ä¶'; }
            });
        }
    })();

    // Read dashboard data (safe JSON) and populate UI
    (function(){
        try{
            const DASH = (function(){
                try{ return JSON.parse(document.getElementById('dashboard-data').textContent); }catch(e){ return { total: null, items: [] }; }
            })();

            // Populate visible totals
            (function(){
                const cEl = document.getElementById('caloriesVal');
                const pEl = document.getElementById('proteinVal');
                const fEl = document.getElementById('fatVal');
                const total = DASH && DASH.total ? DASH.total : null;
                if(cEl) cEl.textContent = total && total.calories ? (total.calories + ' kcal') : '‚Äî';
                if(pEl) pEl.textContent = total && total.protein ? (total.protein + ' g') : '‚Äî';
                if(fEl) fEl.textContent = total && total.fat ? (total.fat + ' g') : '‚Äî';
            })();

            // Macro doughnut chart
            (function(){
                const total = DASH && DASH.total ? DASH.total : {protein:0,fat:0,carbs:0};
                const c = document.getElementById('macroChart');
                if(c){
                    new Chart(c, {
                        type: 'doughnut',
                        data: {
                            labels: ['Protein (g)','Fat (g)','Carbs (g)'],
                            datasets: [{
                                data: [Number(total.protein)||0, Number(total.fat)||0, Number(total.carbs)||0],
                                backgroundColor: ['#4fd1c5','#ffd166','#ffa69e'],
                                borderWidth: 0
                            }]
                        },
                        options: {cutout: '70%',plugins: { legend: {display:false} }}
                    });
                }
            })();
        }catch(err){console.warn('dashboard data populate failed:',err)}
    })();

    // Additional charts in left panel (quick insights) and CSV export ‚Äî use DASH items
    (function(){
        try{
            const DASH = (function(){
                try{ return JSON.parse(document.getElementById('dashboard-data').textContent); }catch(e){ return { items: [] }; }
            })();
            const items = DASH.items || [];
            const itemLabels = items.length ? items.map(it => it.food || '‚Äî') : ['‚Äî'];
            const itemCals = items.length ? items.map(it => Number(it.calories) || 0) : [0];

            // Item calories horizontal chart
            const ctxItem = document.getElementById('itemCalChart');
            if(ctxItem){
                new Chart(ctxItem, {
                    type:'bar',
                    data:{labels:itemLabels,datasets:[{label:'Calories',data:itemCals,backgroundColor:'#ff7a9a'}]},
                    options:{indexAxis:'y',scales:{x:{beginAtZero:true}},plugins:{legend:{display:false}},responsive:true,maintainAspectRatio:false}
                });
            }

            // CSV export for nutrition summary ‚Äî build from DASH
            const btn = document.getElementById('downloadCsv');
            if(btn){
                btn.addEventListener('click', function(){
                    const rows = [['food','grams','calories','protein_g','fat_g','carbs_g','fiber_g']];
                    items.forEach(i => rows.push([i.food || '', i.grams || '', i.calories || '', i.protein || '', i.fat || '', i.carbs || '', i.fiber || '']));
                    const total = DASH.total || null;
                    if(total) rows.push(['Total', total.grams || '', total.calories || '', total.protein || '', total.fat || '', total.carbs || '', total.fiber || '']);
                    const csv = rows.map(r => r.map(c=> '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
                    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
                    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'nutrition_summary.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                });
            }

        }catch(err){console.warn('left panel charts / csv failed:',err)}
    })();


// Debug panel behaviour
(function(){
    try{
        const logs = [];
        const debugBtn = document.getElementById('debugBtn');
        const debugPanel = document.getElementById('debugPanel');
        const debugList = document.getElementById('debugList');
        const debugCount = document.getElementById('debugCount');
        const debugCopy = document.getElementById('debugCopy');
        const debugClear = document.getElementById('debugClear');

        function render(){
            if(!debugList) return;
            debugList.innerHTML = logs.slice().reverse().map(l => `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"><div style="color:#ffd6a5">${l.type}</div><div>${l.msg}</div><div style="color:#9fb3d9;font-size:11px;margin-top:6px">${l.when}</div></div>`).join('');
            if(debugCount) debugCount.textContent = String(logs.length);
        }

        function pushLog(type,msg){ logs.push({type,type, msg: String(msg), when: new Date().toLocaleString()}); if(logs.length>500) logs.shift(); render(); }

        // capture window errors
        window.addEventListener('error', function(e){ pushLog('error', e.message + ' @ ' + (e.filename||'') + ':' + (e.lineno||'') ); });
        window.addEventListener('unhandledrejection', function(e){ pushLog('promise', e.reason && e.reason.message ? e.reason.message : JSON.stringify(e.reason)); });

        // intercept console.error
        (function(){ const orig = console.error; console.error = function(){ try{ pushLog('console.error', Array.from(arguments).map(a=> (typeof a==='object'? JSON.stringify(a):a)).join(' ')); }catch(e){} orig.apply(console,arguments); } })();

        if(debugBtn) debugBtn.addEventListener('click', function(){ if(debugPanel) debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none'; });
        if(debugCopy) debugCopy.addEventListener('click', function(){ const text = logs.map(l=>`[${l.when}] ${l.type} - ${l.msg}`).join('\n'); navigator.clipboard && navigator.clipboard.writeText(text); });
        if(debugClear) debugClear.addEventListener('click', function(){ logs.length = 0; render(); });

        // initial render
        render();

    }catch(e){console.warn('debug panel failed', e)}
})();
</script>
<script>
(function(){
    try{
        const b = document.querySelector('.streak-badge[data-count]');
        if(!b) return;
        const ds = b.dataset.color || '';
        b.style.background = ds || b.style.background || 'var(--accent-solid)';

        // Try to set a readable text color based on hex/rgb brightness when possible
        function pickTextColor(bg){
            try{
                bg = String(bg).trim();
                if(bg.startsWith('#')){
                    const hex = bg.slice(1);
                    const r = parseInt(hex.length===3? hex[0]+hex[0] : hex.slice(0,2),16);
                    const g = parseInt(hex.length===3? hex[1]+hex[1] : hex.slice(2,4),16);
                    const bval = parseInt(hex.length===3? hex[2]+hex[2] : hex.slice(4,6),16);
                    const brightness = (r*299 + g*587 + bval*114)/1000;
                    return brightness > 150 ? '#071028' : '#ffffff';
                } else if(bg.startsWith('rgb')){
                    const parts = bg.replace(/[rgba() ]/g,'').split(',').map(s=>Number(s)||0);
                    const brightness = (parts[0]*299 + parts[1]*587 + parts[2]*114)/1000;
                    return brightness > 150 ? '#071028' : '#ffffff';
                }
            }catch(e){ }
            // fallback: for dashboard keep dark text for the larger home badge, else white
            return b.classList.contains('streak-badge--home') ? '#071028' : '#ffffff';
        }

        b.style.color = pickTextColor(ds || window.getComputedStyle(b).backgroundImage || b.style.background);

        const cur = Number(b.dataset.count || 0);
        const key = 'fn_last_streak';
        const prev = Number(localStorage.getItem(key) || 0);
        if(cur > prev && prev >= 0){ b.classList.add('streak-increment'); setTimeout(()=>b.classList.remove('streak-increment'), 1400); }
        localStorage.setItem(key, String(cur));
    }catch(e){console.warn('streak init',e)}
})();
</script>
<script>
(function(){
    try{
        const pBtn = document.getElementById('profileBtn');
        const pDrop = document.getElementById('profileDropdown');
        if(pBtn){
            pBtn.addEventListener('click', function(ev){ ev.stopPropagation(); const opened = pBtn.getAttribute('aria-expanded') === 'true'; pBtn.setAttribute('aria-expanded', String(!opened)); pDrop.style.display = opened ? 'none' : 'block'; });
            document.addEventListener('click', function(){ if(pDrop){ pDrop.style.display = 'none'; pBtn.setAttribute('aria-expanded','false'); } });
        }
    }catch(e){ console.warn('profile menu init', e); }
})();
</script>

<!-- NutriLog modal -->
<style>
  /* Consistent vertical spacing in the modal card */
  .fn-modal-card #fnModalMain > * + * { margin-top: 8px; }

  /* Image spacing: double space above, larger gap below */
  .fn-modal-card .fn-modal-logo { margin: 28px 0 20px; }

  /* Title & description spacing */
  .fn-modal-card .fn-modal-title { font-size:22px; text-align:center; margin-top:0; }
  .fn-modal-card .fn-modal-desc { font-size:15px; text-align:center; margin-top:6px; }

  /* Turn Back button spacing */
  .fn-modal-card .fn-modal-actions { margin-top:14px; display:flex; justify-content:center; }

  /* Credits spacing: title, list, footer */
  .fn-modal-card .fn-modal-credits > * + * { margin-top:10px; }
  .fn-modal-card .fn-modal-credits .credits-title { font-weight:900; font-size:20px; text-align:center; margin-bottom:8px; display:block; }
  .fn-modal-card .fn-modal-credits ul { gap:8px; margin:0; padding:0; list-style:none; display:flex; flex-direction:column; align-items:center; justify-content:center; }
  .fn-modal-card .fn-modal-footer { margin-top:14px; display:flex; justify-content:center; gap:12px; }
</style>
<div id="fnModal" class="fn-modal-overlay" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="fn-modal-card" role="document">
    <button class="fn-modal-close" id="fnModalClose" aria-label="Close">‚úï</button>
    <div id="fnModalMain">
      <div class="fn-modal-logo" style="display:flex;justify-content:center"><img src="/data/nutrilog_logo.png" alt="NutriLog" style="width:280px;max-width:88%;height:auto;border-radius:12px"></div>
        <div class="fn-modal-title" style="text-align:center;font-size:22px">NutriLog</div>
        <div class="fn-modal-desc" style="text-align:center;font-size:15px">Eat Smart. Track Better.</div>
      <div class="fn-modal-actions" style="display:flex;justify-content:center;margin-top:18px">
        <button id="fnTurnBack" class="fn-btn glow">Turn Back ‚Üí</button>
      </div>
    </div>

    <div id="fnCredits" class="fn-modal-credits" aria-hidden="true">
      <!--<div class="credits-title">Created By</div>
      <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center">
        <li style="font-size:18px;font-weight:900"><span class="symbol">‚ö°</span> ANISH M</li>
        <li style="font-size:18px;font-weight:900"><span class="symbol">üî•</span> MOHANALINGAM M</li>
        <li style="font-size:18px;font-weight:900"><span class="symbol">‚≠ê</span> PRAVEEN M</li>
        <li style="font-size:18px;font-weight:900"><span class="symbol">‚ú®</span> MOULESH G S</li>
        <li style="font-size:18px;font-weight:900"><span class="symbol">üçÉ</span> SYED AMASH S</li>
      </ul>-->

      <!-- Short app description (visible on the Credits back of the modal) -->
      <div class="fn-modal-app-desc" style="text-align:center;color:var(--muted);font-size:14px;line-height:1.4">
        <div>NutriLog helps you detect foods from photos and track nutrition in seconds.</div>
        <div>Scan items, enter weights, and save meals ‚Äî get instant nutrition totals and history.</div>
        <div>Designed for quick logging, meaningful insights, and easy exports (CSV) for further analysis.</div>
      </div>

      <div class="fn-modal-footer" style="display:flex;justify-content:center;margin-top:18px">
        <a class="fn-github" href="https://github.com/syedamashs/NutriLog" target="_blank">GitHub Repo</a>
        <button id="fnBackFromCredits" class="fn-btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff">Back</button>
      </div>
    </div> 
  </div>
</div>

<script>
(function(){
  try{
    const logoEls = document.querySelectorAll('.logo, .logo img');
    const modal = document.getElementById('fnModal');
    const closeBtn = document.getElementById('fnModalClose');
    const turnBack = document.getElementById('fnTurnBack');
    const credits = document.getElementById('fnCredits');
    const main = document.getElementById('fnModalMain');
    const backFromCredits = document.getElementById('fnBackFromCredits');

    function openModal(){ modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); main.style.display='block'; credits.classList.remove('show'); credits.setAttribute('aria-hidden','true'); }
    function closeModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
    function showCredits(){ main.style.display='none'; credits.classList.add('show'); credits.setAttribute('aria-hidden','false'); }

    logoEls.forEach(el=> el && el.addEventListener('click', function(ev){ ev.preventDefault(); openModal(); }));
    closeBtn && closeBtn.addEventListener('click', closeModal);

    turnBack && turnBack.addEventListener('click', showCredits);
    backFromCredits && backFromCredits.addEventListener('click', openModal);
    modal && modal.addEventListener('click', function(e){ if(e.target === modal) closeModal(); });
  }catch(e){ console.warn('fn modal init', e); }
})();
</script>

</body>
</html>
